# This R script gives us the expected values for JUnit tests
# 'BMPruneLikelihoodTest'
# (1) 'testBMPruneLikelihood3Species1Trait'
# (2) 'testBMPruneLikelihood10Species2Traits'
# (3) 'testBMPruneLikelihood12Species4Traits'
# (4) 'testBMPruneLikelihood3Species1TraitSATree'
# (5) 'testBMPruneLikelihood10Species2TraitsSATree'
# (6) 'testBMPruneLikelihood12Species3TraitsSATree'
# (7) 'testBMPruneLikelihood11Species3TraitsSATree'
# (8) 'testBMPruneLikelihoodWithUpperMatrix12Species4Traits'
# (9) 'testBMPruneLikelihoodWithUpperMatrix10Species10Traits'

library(mvMORPH)
library(PCMBase)
library(TreeSim)

source('BMPruneLikelihoodJUnitTestUtils.R')

## 'BMPruneLikelihoodTest'

### (1) testBMPruneLikelihood3Species1Trait
tr <- read.tree(text = "((sp1:1.0, sp2:1.0):1.0,sp3:2.0);")

dat <- matrix(c(0.3022866, 0.4237119, 2.5298873), nrow = 3, ncol = 1)

res <- mvBM(tr, dat, model="BM1")
res$sigma # 0.449638667542283 --> this is the sigmasq to be specified

res$LogLik # -3.95372886237383

### (2) testBMPruneLikelihood10Species2Traits
tr <- read.tree(text = "(((t3:1.209461463,t4:1.209461463):0.6659547705,(t9:0.841016425,t10:0.841016425):1.034399809):1.561956365,(((t2:1.602817551,(t5:1.164343725,t6:1.164343725):0.4384738261):0.6643605462,t1:2.267178098):0.7120187616,(t7:1.115655119,t8:1.115655119):1.86354174):0.458175739);")

dat <- matrix(c(0.326278727608277, 1.8164550628074,
                -0.370085503473201, 0.665116986641999,
                1.17377224776421, 3.59440970719762,
                3.38137444987329, -0.187743059073837,
                -1.64759474375234, -2.19534387982435,
                -3.22668212260941, -1.71183724870188,
                1.81925405275285, -0.428821390843389,
                4.22298205455098, 1.51483058860744,
                3.63674837097173, 3.68456953445085,
                -0.743303344769609, 1.10602125889508), nrow = 10, ncol = 2)

res <- mvBM(tr, dat, model="BM1")

# this is the trait rate matrix
rate.matrix <- res$sigma 

# this the sigmasq for the 2 traits -> 0.93818618860063 1.74928729364035
sigmasq <- diag(rate.matrix) 
correlations <- calculate.correlations(rate.matrix) # -0.117852694436286 -> this the correlation (rho) between the 2 traits

res$LogLik # -39.588461762377

### (3) testBMPruneLikelihood12Species4Traits
tr <- read.tree(text = "(t1:0.4387394809,((((t9:0.04695960989,t10:0.04695960989):0.3330763616,t3:0.3800359715):0.02593808098,(t4:0.3763515397,((t5:0.3336782345,t6:0.3336782345):0.001793424038,((t11:0.01775546957,t12:0.01775546957):0.2525263158,(t7:0.1384768423,t8:0.1384768423):0.1318049431):0.06518987311):0.04087988122):0.02962251275):0.005880353322,t2:0.2469241568):0.3393625325);")

dat <- matrix(c(0.353663344600893, -0.260659762787646, -0.143297771543009, -0.320198017359097,
                1.58652065854415, 0.473150703285599, 1.13940033793728, 0.181057545027617,
                0.161848086456716, 0.876042348041411, 1.34896801425551, 0.735955677879521,
                0.229894452237773, -0.889968417857947, -1.01928746070036, -0.221714820148973,
                0.866034091552559, -0.547837172102502, -0.0992925133953159, -0.10664389071908,
                -0.351658729601069, -0.391407502463039, -0.742998450279645, -0.974386073214283,
                -1.04988557964476, -1.55616727235143, -1.09488792059502, -0.316592979435508,
                0.607662577851945, 1.05672142780744, 2.11008014995751, 0.622428141848601,
                0.274713820329526, 0.934277091068923, 1.19164140228254, 0.120739155255668,
                -1.00377460950264, -1.58433907435323, -1.15487441742173, 0.193491613863128,
                0.858965417527042, 0.435337697033783, 1.67013615353965, 0.461563348647148,
                0.0131752572461055, 0.628852350924242, 0.649028779617329, 0.00815911328976909), nrow = 12, ncol = 4)          

res <- mvBM(tr, dat, model="BM1")

# this is the trait rate matrix
rate.matrix <- res$sigma 

# this the sigmasq for the 4 traits -> 0.804871980105083 0.800898201871183 2.09870835915248 1.86668646924725
sigmasq <- diag(rate.matrix) 

# this the correlation (rho) between the 4 traits -> 0.249601961161705 0.621690109504647 0.557763570789255 0.253263068559957 0.465328436445763 0.942027722595717
correlations <- calculate.correlations(rate.matrix)

res$LogLik # -24.3878360967573

### (4) testBMPruneLikelihood3Species1TraitSATree
tr <- read.tree(text = "((t1:1.0,t2:0.0):2.0,t3:3.0);")

dat <- matrix(c(2.0,3.0,1.0), nrow = 3, ncol = 1)

res <- mvBM(tr, dat, model="BM1")

# this is the trait rate matrix -> 0.6
rate.matrix <- res$sigma 

res$LogLik # -4.38645689857906

### (5) testBMPruneLikelihood10Species2TraitsSATree
tr <- read.tree(text = "(((t3:1.209461463,t4:0.0):0.6659547705,(t9:0.841016425,t10:0.841016425):1.034399809):1.561956365,(((t2:1.602817551,(t5:1.164343725,t6:1.164343725):0.4384738261):0.6643605462,t1:2.267178098):0.7120187616,(t7:1.115655119,t8:1.115655119):1.86354174):0.458175739);")

dat <- matrix(c(-4.12523015629711, -1.62252112839929, -2.44641157681447, -1.54740433331906,
                0.881613016929177, -0.217262173674136, 1.62614740980059, -2.89454199395993,
                2.45457588141588, 2.38497975048708, 5.46820550439604, 1.33650033921425,
                2.84921644558551, -0.0963333650163727, -1.79728580710375, 1.72609075255175,
                -1.7120872848909, 4.49117923198017, -6.28243322556914, -5.5445431329235), nrow = 10, ncol = 2)

res <- mvBM(tr, dat, model="BM1")

# this is the trait rate matrix
rate.matrix <- res$sigma 

# this the sigmasq for the 2 traits -> 1.48219485482393 4.86284297861765
sigmasq <- diag(rate.matrix) 

# this the correlation (rho) between the 2 traits -> -0.956694237525586
correlations <- calculate.correlations(rate.matrix) 

res$LogLik # -33.6679664296583

### (6) testBMPruneLikelihood12Species3TraitsSATree
tr <- read.tree(text = "(t1:0.0162595512,((t2:0.2981734165,t3:0.07231244369):0.320819053,((((t11:0.003069371137,t12:0.003069371137):0.2591040945,t7:0.2621734657):0.1989762127,(t8:0.1021021305,(t9:0.02930302334,t10:0.02930302334):0.07279910718):0.3590475478):0.02879665668,(t4:0.0,(t5:0.2669991903,t6:0.2669991903):0.049200328):0.1737468167):0.3260942874):0.1839593776):0.0;")

dat <- matrix(c( 0.215000043472759, 0.776521767392364, 0.274864229944774,
                 -0.466686896787782, -0.588015333642268, -0.262434175362964,
                 -0.87131974904876, -1.16217914558771, -1.43173438937441,
                 -0.232384120150305, -0.217673646874237, -0.271431937473855,
                 0.141278178809372, 0.668704872177164, 0.806715774880128,
                 -0.265669698753016, -0.332967508179201, 0.031825032167221,
                 -1.16155653990928, -1.41785772734122, -1.99988027886332,
                 -1.13606986874854, -0.68027906300786, -1.65892990236907,
                 0.226642733376528, 0.176856072807917, -0.762567216544748,
                 0.0870906123165553, -0.0827301327675375, 0.112420939261318,
                 0.00307828088038135, -0.668474831682343, -0.768766703759037,
                 0.391361803506349, 0.317349178510409, 0.0162183133279696), nrow = 12, ncol = 3)

res <- mvBM(tr, dat, model="BM1")

# this is the trait rate matrix
rate.matrix <- res$sigma 

# this the sigmasq for the 3 traits -> 0.638576947855446 1.39965531064881 1.05567638176245
sigmasq <- diag(rate.matrix) 

# this the correlation (rho) among the 3 traits -> 0.701335425949266 0.752711770643294 0.281971108329001
correlations <- calculate.correlations(rate.matrix) 

res$LogLik # -9.5414237837198

### (7) testBMPruneLikelihood11Species3TraitsSATree
tr <- read.tree(text = "(((((t3:0.1588129446,t4:0.1588129446):0.01705137773,((t6:0.09203097793,t7:0.09203097793):0.02043978126,t5:0.0):0.06339356319):0.06941873281,(t8:0.03465123152,t9:0.03465123152):0.2106318237):0.4596163207,t1:0.0):0.4342545645,((t10:0.01280757,t11:0.01280757):0.6723641561,t2:0.6851717261):0.4539822143);") 

dat <- matrix(c(-1.21564787174142, -1.1851671823634, -0.694393171280324,
                -0.590751944909478, -0.884946580491066, -0.639187501019874,
                -0.705615140755287, -0.543347975313145, -0.41310125318572,
                -0.578200681462636, 0.10299350447178, -4.03137227081675,
                -3.60553672704412, -3.03652095560971, -3.44783973931706,
                -3.48302742703454, -2.23470805810516, -2.06463132261412,
                -1.45735336840457, 2.02935389582742, 2.04503536970991,
                0.793454794733989, -0.658138349771025, -0.0445842979883116,
                0.521821220721283, -0.596693734056411, -0.173523045052619,
                -0.0197703417294821, 0.136084231018102, -0.883187635997939,
                -0.398893370910344, -0.596179783025397, 0.407591907174602), nrow = 11, ncol = 3)

res <- mvBM(tr, dat, model="BM1")

# this is the trait rate matrix
rate.matrix <- res$sigma 

# this the sigmasq for the 3 traits -> 0.330573813299717 2.10107882103254 1.16247744113921
sigmasq <- diag(rate.matrix) 

# this the correlation (rho) among the 3 traits -> 0.431864494724112 0.269799734687143 0.265743456659158
correlations <- calculate.correlations(rate.matrix) 

res$LogLik # -19.6436871314934

### (8) testBMPruneLikelihoodWithUpperMatrix12Species4Traits
tr <- read.tree(text = "(t1:0.4387394809,((((t9:0.04695960989,t10:0.04695960989):0.3330763616,t3:0.3800359715):0.02593808098,(t4:0.3763515397,((t5:0.3336782345,t6:0.3336782345):0.001793424038,((t11:0.01775546957,t12:0.01775546957):0.2525263158,(t7:0.1384768423,t8:0.1384768423):0.1318049431):0.06518987311):0.04087988122):0.02962251275):0.005880353322,t2:0.2469241568):0.3393625325);")

# simulate continuous traits on the tree
trait.nr <- 4
set.seed(123)
# draw root values from Normal(0, 2)
root.values.sim <- rnorm(trait.nr, mean = 0.0, sd = 2.0)

# draw sigmasq from LogNormal(1, 0.3)
# -> 2.82578533469758 4.54723563720239 3.12137890774279 1.85982357228878
sigmasq <- rlnorm(trait.nr, meanlog = 1.0, sdlog = 0.3)

# draw corrlations from Uniform(-1, 1)
# -> -0.50782453129068 -0.915880932938308 -0.344158561434597 0.909007298294455 0.779078632127494 0.385606812313199
correlation <- runif(trait.nr * (trait.nr - 1) / 2, min = -1.0, max = 1.0)

# populate upper matrix
upper.matrix = populate.upper.matrix(trait.nr, sigmasq, correlation)

# this is the trait rate matrix
rate.matrix <- upper.matrix %*% t(upper.matrix)

dat <- mvSIM(tr, param=list(sigma = rate.matrix, ntraits = trait.nr, theta = root.values.sim), model="BM1", nsim = 1)
# dat <- matrix(c(-0.0733746173961214, 5.68659715338688, 4.63420888471096, -0.318730233572463,
#                 1.62978685097024, 0.376724598790307, 3.00252253755152, 0.398482000569861,
#                 2.22178666226494, 0.180126949417046, 0.591666553277025, 4.94126662089152,
#                 -0.381897460527792, -5.45349811184419, -5.88280081877496, -2.70069110253073,
#                 -6.84755589169306, -0.440758737091378, -3.3301298265687, -3.82369481378681,
#                 -4.61332643056133, -0.193404866088525, -1.45443665996485, -10.453621232694,
#                 3.01043044622191, -3.77414740185529, -3.4666212861778, -2.53053047827026,
#                 0.481033646574288, 2.01600437393992, -0.367727022453056, 0.0209910108874771,
#                 -1.12402308648343, 0.791628971761537, 1.99527559017226, -1.72287824100249,
#                 -0.377856855072646, 0.57882637837598, -0.148236089777769, 0.862306413264445,
#                 0.53010180261091, 2.00282132665632, 0.657269080077358, -0.765003421521001,
#                 -0.857024153578214, 0.906574999646124, 0.605770740459275, -0.133159221643173), nrow = 12, ncol = 4)

res1 <- mvLL(tr, data = dat, method = "pic", param = list(estim = FALSE, sigma = rate.matrix))

root.values <- res1$theta # 1.31333963835203 -2.98702012630774 0.917483561572151 0.042377739810620
lnLk1 <- res1$logl # -86.0358011352751

# use PCMBase package to calculate the likelihood
modelBM <- PCM("BM", k = trait.nr, regimes = 1)
modelBM$X0[] <- root.values
modelBM$Sigma_x[,,1] <- upper.matrix
modelBM$Sigmae_x <- NULL
res2 <- PCMLik(t(dat), tr, modelBM)
lnLk2 <- res2[1] # -86.0358011352751

### (9) testBMPruneLikelihoodWithUpperMatrix10Species10Traits
tr <- read.tree(text = "(((t4:0.01700026351,t10:0.01700026351):0.9034244971,(t2:0.2519264674,t1:0.2519264674):0.6684982932):0.2901851714,((t9:0.4243929597,t5:0.4243929597):0.428956968,((t3:0.1329259849,t6:0.1329259849):0.5897285177,(t7:0.3444839115,t8:0.3444839115):0.3781705911):0.1306954251):0.3572600043):0.0;")

# simulate continuous traits on the tree
trait.nr <- 10
set.seed(123)
# draw root values from Normal(0, 2)
root.values.sim <- rnorm(trait.nr, mean = 0.0, sd = 2.0)

# draw sigmasq from LogNormal(1, 0.3)
# -> 3.92444342735533 3.02812661102414 3.06556360045831 2.81005713192123 2.30077876608194 4.64631271741818 3.15615698487533 1.50684016606037 3.3548490285494 2.35882255622108
sigmasq <- rlnorm(trait.nr, meanlog = 1.0, sdlog = 0.3)

# draw corrlations from Uniform(-1, 1)
# -> -0.714399955235422 -0.170907328370959 -0.172551347408444 -0.262309098150581 -0.695110504515469 -0.722387873101979 -0.533931801095605 -0.0680750994943082 -0.468054719269276 0.715655430685729 -0.908337666653097 -0.11559985158965 0.597849691286683 -0.75620148004964 0.121895967517048 -0.58693722076714 -0.744936699513346 0.506615728605539 0.790090718306601 -0.251074448227882 0.33023038925603 -0.810318678151816 -0.232060724403709 -0.451232710853219 0.629280077759176 -0.102967317216098 0.620128706097603 0.624779019039124 0.588684642221779 -0.120336624793708 0.508950317278504 0.258442263118923 0.420364802703261 -0.998750453349203 -0.0493668518029153 -0.55976222967729 -0.24036692455411 0.225542006548494 -0.296404181513935 -0.777729151304811 -0.512761054560542 0.336111174896359 -0.164706440642476 0.576391668058932 -0.794270711485296
correlation <- runif(trait.nr * (trait.nr - 1) / 2, min = -1.0, max = 1.0)

# populate upper matrix
upper.matrix <- populate.upper.matrix(trait.nr, sigmasq, correlation)

# this is the trait rate matrix
rate.matrix <- upper.matrix %*% t(upper.matrix)

dat <- mvSIM(tr, param=list(sigma = rate.matrix, ntraits = trait.nr, theta = root.values.sim), model="BM1", nsim = 1)
# dat <- matrix(c(-2.28731878531972, -0.811378577256192, 13.6231428892787, 7.16152550409223, -0.519423079492719,
#                 -0.984130963068706, 6.92575877256499, 5.0957217584282, 5.26074139751262, 4.83917711885396,
#                 8.16016797286394, 8.18829611082131, -8.90573230225415, -12.1514214682735, -5.77669193046342,
#                 -3.0397054776387, -6.37840622885572, -5.25782891756779, 7.6536042206705, 1.77623369001487,
#                 -1.60790363996585, -2.45648222243076, 4.21682244085758, 5.53944577979937, -0.312497972990135,
#                 6.09565103724857, -1.76067360986415, 2.13664343352796, 5.13405841572984, 3.99553867000827,
#                 -3.50375146318285, -4.4274634946743, 4.60332633627662, 7.14147083928846, -1.59583025877346,
#                 -0.840066990821478, -3.77388932553854, -2.64427540812803, -8.23652751442488, -10.5516684942347,
#                 2.4180310750393, 3.03356006715664, -0.716172061308149, -1.89982704153151, 1.3446283692346,
#                 3.15088198649174, -0.453482143262971, -2.19363406695927, -0.431284906380698, -3.257852292301,
#                 4.09620039236067, 3.3252839398938, 0.345250157267404, -2.16553733680629, 2.99774158156863,
#                 1.77512813315887, 3.60403255588672, 2.25231513022396, 8.90155578270267, 6.47320619083183,
#                 -5.17365781499908, -4.21928449405138, -0.749225468028548, -0.093001131322756, 3.65399830020205,
#                 6.02316315859529, 1.3112428586143, 3.09693981602772, 0.0936214074138489, 3.74483134602231,
#                 0.0830324263435673, 0.150249836685309, -3.41701294175762, -3.32603366513231, -1.69746045226351,
#                 -2.73207211765912, -0.732024175817608, -1.64956110239375, -3.00924775897672, -3.62473323746156,
#                 -3.92697498145996, -4.97807077472762, 0.994478698194049, 1.53951108454289, -5.82006681351925,
#                 -3.7025682293389, -3.42667016024356, -2.18351165272075, -2.18342919122651, -5.92016122137718,
#                 1.23323556462526, 1.03044047843148, -3.44063534931992, -2.64755502918416, 0.84039105047492,
#                 -0.571614944120547, 2.3074920977748, 2.14200618566428, 1.66729459543154, 3.14670114612779), nrow = 10, ncol = 10)

res1 <- mvLL(tr, data = dat, method = "pic", param = list(estim = FALSE, sigma = rate.matrix))

root.values <- res1$theta # 3.83820964854587 -1.82229222768521 2.2184830548975 -1.78068597015808 0.231608084769115 2.86421254788985 0.588790071121921 -2.04130889291833 -2.79397701252233 0.268330027718606
lnLk1 <- res1$logl # -205.515395500167

# use PCMBase package to calculate the likelihood
modelBM <- PCM("BM", k = trait.nr, regimes = 1)
modelBM$X0[] <- root.values
modelBM$Sigma_x[,,1] <- upper.matrix
modelBM$Sigmae_x <- NULL
res2 <- PCMLik(t(dat), tr, modelBM)
lnLk2 <- res2[1] # -205.515395500167