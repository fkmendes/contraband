# author: Fabio K. Mendes
# This R script gives us the expected values for JUnit tests
# (1) 'BMMVNLikelihoodTest'
# (2) 'BMMVNLikelihoodTest2'
# (3) 'BMMVNLikelihoodTest3'

library(mvMORPH)
library(TreeSim)
library(geiger)
library(Rcpp)
sourceCpp(file="./bm_direct_new.cpp")
source("coalBM_lib.R")

## (1) 'BMMVNLikelihoodTest'

tr <- read.tree(text="((sp1:1.0,sp2:1.0):1.0,sp3:2.0);")

dat <- data.frame(c(4.1, 4.5, 5.9))
row.names(dat) <- c("sp1", "sp2", "sp3")

res <- mvBM(tr, dat, model="BM1")
res$sigma # 0.2704762
res$theta # 4.985714
res$LogLik # -3.191339

# lnLk2 below (with root edge)
tr <-  read.tree(text="(((sp1:1.0,sp2:1.0):1.0,sp3:2.0):1.0,sp4:3.0);")
dat <- c(4.1, 4.5, 5.9, 0.0)
names(dat) <- c("sp1", "sp2", "sp3", "sp4")
res <- fitContinuous(tr, dat)
res$opt$sigsq # 0.2704762
res$opt$z0 # 4.985714
res$opt$lnL # -3.577933, this is with pruning

dat <- c(4.1, 4.5, 5.9)
names(dat) <- c("sp1", "sp2", "sp3")
vcvmat <- vcv.phylo(tr) # gets the tree's variance-covariance matrix
vcvmat <- vcvmat[-4,-4]

res <- mle.analytical(obs.data=dat, sigma.mat=vcvmat)
res$mean # 4.9857143
res$sigma.mat # 0.2704762
res$lnL # -3.5779335 # this is analytically

## (2) 'BMMVNLikelihoodTest2'

set.seed(123)

## simulating birth-death tree
lambda <- rexp(1, rate=80) # lambda from exponential (mean = 1/80)
mu <- rexp(1, rate=100) # mu from exponential (mean = 1/100)
tr <- sim.bd.taxa.age(50, 1, lambda, mu, age=100, mrca=TRUE)[[1]]; write.tree(tr) # mrca=TRUE means the process starts at the root (i.e., no root edge)

# arbitrary values below
sigma <- 0.02914682
rv <- 2.219841

dat <- fastBM(tr, sig2=sigma, a=rv)

paste(tr$tip.label, collapse=",") # "t37,t42,t24,t19,t12,t5,t18,t25,t10,t47,t9,t20,t14,t43,t38,t13,t41,t50,t8,t35,t32,t34,t6,t48,t39,t17,t15,t40,t46,t29,t22,t16,t28,t31,t45,t23,t7,t4,t36,t11,t49,t3,t27,t26,t33,t21,t2,t44,t30,t1"
paste(dat, collapse=",") # 1.44328035263938,3.50655783665801,2.29555775828889,5.27046225284362,0.530549210673224,-0.368179938156466,0.815471685036162,2.36440615897368,0.175573596016938,0.491308438121729,-0.885496203211391,5.25090092164527,4.5030514546132,2.19144454232363,2.71119474862089,3.80879445057103,3.46409119464282,0.847786178303177,1.60806408491409,0.547111053325457,0.463967494705812,3.02072340616352,2.80516460780011,3.79540161037042,4.27779475259434,2.03094267471497,3.13807747280727,0.944275002969514,1.54863412006962,1.46096257283766,0.501600894450101,4.35582751232989,4.53286880080503,2.22222895258926,4.21286791328812,5.90694686097006,1.08900067374343,2.02041235594081,2.35582048390211,4.36319759634288,3.74261911168354,1.26352894420471,2.06627716143412,3.17509471532883,3.28578252973877,2.24446251234181,3.37402888328658,3.67966179487162,4.45836708983263,4.48179955076661

res <- mvBM(tr, dat, model="BM1")
res$sigma # 0.02813127
res$theta # 2.405835
res$LogLik # -75.79013

## (3) 'BMMVNLikelihoodTest3'

set.seed(123)

tr <- read.tree(text="(((((t35:0.1,t32:0.1):0.1,t10:0.1):0.1,t18:0.1):0.1,(((t47:0.1,t9:0.1):0.1,(t43:0.1,t38:0.1):0.1):0.1,(((((t20:0.1,t14:0.1):0.1,t19:0.1):0.1,(t24:0.1,(((t50:0.1,t8:0.1):0.1,t25:0.1):0.1,(t12:0.1,t5:0.1):0.1):0.1):0.1):0.1,t37:0.1):0.1,(t42:0.1,(t13:0.1,t41:0.1):0.1):0.1):0.1):0.1):0.1,((t34:80.73867518,((t4:14.89974775,t36:14.89974775):7.855467399,t7:22.75521515):57.98346003):16.48666894,((((((((t29:32.9204832,t22:32.9204832):13.17504731,t46:46.09553051):1.732718052,t40:47.82824856):14.51317295,(t28:29.85457377,((t33:6.373725141,t21:6.373725141):1.191235246,t26:7.564960387):22.28961339):32.48684774):5.177695495,t48:67.51911701):2.445324178,(t39:56.9237382,((t2:5.876590264,t44:5.876590264):19.06403767,t23:24.94062793):31.98311027):13.04070299):0.3095854321,(((t11:13.30542076,t49:13.30542076):14.69428372,t45:27.99970449):1.437902517,t31:29.43760701):40.83641961):11.48412211,((((t16:30.59346099,(t30:0.03406798076,t1:0.03406798076):30.55939301):21.47527084,(t17:50.41024027,t15:50.41024027):1.658491566):14.63237622,(t3:10.35007739,t27:10.35007739):56.35103066):2.944577857,t6:69.64568591):12.11246283):15.46719539):2.774655878):0;")

dat <- fastBM(tr, sig2=sigma, a=rv)

paste(tr$tip.label, collapse=",") # "t37,t42,t24,t19,t12,t5,t18,t25,t10,t47,t9,t20,t14,t43,t38,t13,t41,t50,t8,t35,t32,t34,t6,t48,t39,t17,t15,t40,t46,t29,t22,t16,t28,t31,t45,t23,t7,t4,t36,t11,t49,t3,t27,t26,t33,t21,t2,t44,t30,t1"
paste(dat, collapse=",") # 2.27209315774825,2.35770577479828,2.28619045504381,2.10885751414985,2.21395120993299,2.21616242171277,2.10440705636749,2.23088719352124,2.01612727139994,1.97250353865042,2.04619347343212,1.98626432483887,2.13708092824067,2.0924140883466,2.1149054702513,2.21828980377753,2.21523666408597,2.11038317942733,2.20594065029627,2.17222408711307,2.15525917958223,4.61079655144365,2.05099175361785,2.00896701757015,3.48910077756198,2.57568303611276,2.12434389950229,3.2130625470875,3.07020561053238,1.96918061689753,1.3901244857742,1.45248420753707,1.48390042153334,3.53093468620019,2.88001212857536,1.73916538132083,1.74793606069044,2.15738753957675,1.72286491883736,1.81294836498846,2.03876259543693,1.59727328820493,3.91840500639177,3.23605812584825,3.23116427461224,3.04963684259685,1.99914518841533,3.83711101138963,5.36818679644893,4.67121421317176

res <- mvBM(tr, dat, model="BM1")
res$sigma # 0.01925192
res$theta # 2.182659
res$LogLik # -10.8084
