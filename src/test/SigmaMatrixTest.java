package test;

import beast.core.parameter.RealParameter;
import beast.util.TreeParser;
import contraband.prunelikelihood.MorphologicalData;
import contraband.prunelikelihood.SigmaMatrix;
import org.junit.Assert;
import org.junit.Test;
import outercore.parameter.KeyRealParameter;
import java.util.Arrays;
import java.util.List;

public class SigmaMatrixTest {
    private final static double EPSILON = 1e-8;
    private TreeParser tree;
    private String treeStr;
    private String spNames;
    private Integer nTraits;
    private List<Double> contTraitData;
    private List<Double> popTraitData;
    private MorphologicalData morphData = new MorphologicalData();
    private RealParameter sigmasq;
    private RealParameter delta;
    private final SigmaMatrix sigmaMatrix = new SigmaMatrix();
    private final KeyRealParameter contTrait = new KeyRealParameter();
    private final KeyRealParameter population = new KeyRealParameter();

    @Test
    public void testSigmaMatrixWithShrinkage () {
        // tree
        treeStr = "((t6:0.5978754241,(t9:0.1812036647,t10:0.1812036647):0.4166717594):3.369720228,((t2:0.1745779483,(((t5:0.7589371565,(t7:0.4505765447,((t11:0.06734743232,t12:0.06734743232):0.284844007,t8:0.3521914393):0.09838510533):0.3083606118):0.4457746486,t4:1.204711805):0.300021603,t3:0.6809479557):0.8673075902):0.8118002914,t1:3.18384129):0.7837543623);";
        spNames = "t6 t9 t10 t2 t5 t7 t11 t12 t8 t4 t3 t1";
        tree = new TreeParser(treeStr, false, false, true, 0);

        // trait values
        nTraits = 20;
        contTraitData =  Arrays.asList(
                -6.9878325594208, -5.30414266146724, 27.6662681557708, -1.8169162671332, 1.17399489296909, 17.7881747449655, -4.13581901532989, -11.4175045637513, -8.48528940774303, -7.4258507331616, -6.56038779247779, 1.4144709339146, 0.673491045948545, -0.814889001838637, -2.96809672224049, 5.49966814182783, -0.0678434527187006, -5.90643659527902, -8.52512078898373, -15.6318979204402, -13.4778481610118, -7.42651157086464, 15.8489382074443, -6.49079721554969, -2.56706695187222, 4.08299490073864, 4.95335894680952, -12.4499321574086, -12.6250225930478, 1.38792989035181, -10.697430884571, 2.61793958909772, 2.00065037211025, 5.75157106828189, -0.696727101760747, 4.93955875066491, -2.01656755250175, -3.46632335613375, -3.61992406520979, -12.9450685095153, -14.9511240199694, -8.42296129009183, 11.4806870031862, 1.56152280790697, 0.217236540232189, 2.33973825156589, 1.95380113955145, -13.1220606907594, -5.11673019710688, -4.24025862334956, -4.56667072952308, 1.69051011410102, 0.945956420638924, 4.76948074696988, -1.42067605676359, 8.16207620807873, 1.92927198659478, -2.43224166184408, -1.95601904066198, -13.0269015685409, 4.03633264952514, -7.08734850255325, -4.9697463112937, -10.065443639881, -7.79672387023287, 2.80270860853535, 0.687522281849571, -2.97286680650486, -0.876511884671274, 13.8532135755209, -4.74412988224106, -5.54045960665878, 4.92346157174825, 2.47345551952316, -2.6796661714238, 4.64299307579665, 0.741622956411473, -1.21413389719763, 0.668098177022336, -3.51944228498883, 3.75998150793524, 0.488436975177814, -10.4838087153565, -2.64918848192688, -10.5203167582402, 5.9306897901624, 9.23144898218218, 0.745063268167117, 0.658258783041922, 17.5688894731568, -6.40432760580971, -0.726793145058408, 3.58247990669422, -2.27891242137309, 6.17644094426934, 2.38936191349293, -0.936687701888153, -0.665202525409561, 2.23110730987797, -4.5609569162805, -1.74474385223716, 1.41406900473349, -10.3805629982608, -6.77695597039262, -15.1027894503887, 3.82889743819498, 3.83458913872685, -11.0794390864825, 0.404701550240339, 18.8288448514963, -9.96607098935156, -1.52787231349538, -0.612209556156323, 0.74098696595879, 7.56120467701223, 0.879246020865867, -7.0638343999466, 2.8836596523449, 8.06172376142101, 2.78934891207124, 0.861020970276682, -8.73084715248091, -12.5616707372073, -7.91776156940434, -4.66787471653656, 0.843776042364212, 4.94945724802331, -5.73458990676399, -4.97505423831286, 17.3404146262464, -6.68184669916801, 1.19042793582481, 2.29584515774305, -3.07641579614851, -1.0488691129725, 5.08737367017132, -0.58473537387266, -2.07616519368405, 4.41906255166777, -2.52718973699446, 2.50955319839993, -8.87066387783136, -17.4122766249335, -10.8995124993414, -8.11969677935963, 0.282533845236318, 3.04693804380838, -5.44418330073535, -2.89246123549107, 18.9098227601659, -3.25424861183869, 1.78120295454472, 2.58200362219311, -5.63773287204416, -2.72937951369546, 4.4409002831629, 0.267825767939678, -2.1166879149004, 2.37824973988687, -2.04532918028499, 6.20600018362675, -12.9451647228063, -20.6704902421393, 5.52533462169983, -12.2844949961085, 5.45312639902271, 1.88762575795227, -9.29940002071467, 7.50367554829573, 13.9762378804777, -4.15893487532529, 0.349933145380076, 1.34790698563085, -1.10863013830703, 2.76504139516024, 1.51443959048911, -1.18952859842941, 2.03936038155696, 6.41187341106794, -0.692303891178107, -6.41712439018672, 13.1993835972498, -14.2103482367225, -10.899486621199, -12.2668620828483, 0.149260649177463, 17.7158299117815, -3.25028116731155, 1.90191489935059, 15.4279108715715, -6.52484686641853, -2.22617068922453, 1.15467772848139, -2.47073095440742, 4.72252212309494, 11.3542789892563, 4.55419309896315, -3.74483564733481, 1.13218966139533, -6.27224236707323, 16.8695017602303, 15.1897824255863, -17.2052228064977, -2.69029626388866, -13.3755480158714, 2.56617971718437, 3.96060136978019, -5.5114694465443, 12.1341572482481, 15.4709773691715, 2.29167078978118, -0.317947676511234, 3.18404877069224, -7.5986618386232, -3.87663796237451, 9.23479345968263, 10.0103358435773, -3.34445973906355, -2.74384520764971, -5.76890020977153, -5.03111843991438, 10.6187669664545, 14.7383854734068, 3.28767256481952, -9.15294396027177, 1.47224038184486, -6.45572637431518, -9.15379921792312, 12.6221164824973, -5.58362815225903, 14.9731015100217, -4.28351443007061, 0.202950842539217, -10.2648134517461, -6.26676257013047, 7.81384371458543, 1.56773287883796, -4.87704452262818, -7.91208144957896, -8.14005870798819
        );
        contTrait.initByName("value", contTraitData, "keys", spNames, "minordimension", nTraits);
        morphData.initByName("traits", contTrait, "tree", tree);

        popTraitData = Arrays.asList(
                -1.27533177947283, 0.509225664518849, -1.78267983890746, -0.288391911443799, -1.40956311184113, -0.461537618925858, -0.335216650160731, -1.20588729897715, -0.709091947020726, 0.278647723041507, -1.42526269661991, -1.290203095529, -0.597209535820487, 0.729694725502736, -0.013071797545902, 0.0728827145545652, 0.337855332658719, -0.930236640562306, -1.7781822668918, -0.500410823339012, -0.945033622403893, -0.355042305863249, -0.932831047578908, -1.00992761591288, -0.922773410940212, -0.743402888269316, -1.21717958602992, -3.02402500856143, -0.329575731794282, -0.166459173412543, -0.457972423764083, -0.10689181069558, -1.66233074710542, -0.263352079841398, -0.977053622323081, 0.054186108080297, -1.76403313958668, -0.649563099395298, 0.548329043168877, -1.03954204441145, 0.843852181228511, -0.314084682326561, -1.74086058122785, 0.180269528124409, -1.98025248448888, -0.757726590211929, -1.04806351659003, 0.290882391541644, -1.08551616471302, -0.476124397809172, -0.961548011382987, -2.33273884120978, -1.20541357662128, -0.673623210927673, -2.2870002920661, -0.382653553970495, -1.97501137767873, -0.748923386659077, -1.06450652087417, -0.620272604747041, -0.644347741496037, -0.604173416975493, -1.44374736221175, 0.163277354612429, 1.4540998324179, 0.653746151093845, -1.7334315160277, -1.42405689550301, -0.0704795844017799, -1.34276220895998, -1.06239873231835, -0.770418098445152, -0.97094832511886, -1.13735296526024, -2.22952378670236, -1.72323274119762, 2.52618380202179, 1.41359576609557, -1.58036899557399, -1.61021949089815, -0.585568397759667, -1.27069726767469, -1.33989540076987, 0.106724948716874, 0.493105865384378, -0.94062711857988, -1.78664735939619, -1.40286474938797, -0.935342694739363, 0.645796315609395, -1.66647470018563, -0.195448928977151, 1.12900587231159, -2.76810335446113, -2.31639230649521, -0.834308739551272, -1.13171372108104, -1.45619222919344, -0.951135701861709, -2.02565766624859, 1.00020885396267, 1.07205700388247, -2.40154944366303, -0.0262158788205219, -1.83796471612396, 0.801614471508927, -0.411327491516355, 0.310715236776086, -0.383074169004916, -1.31511572006774, -0.759883857729533, -0.413702770753898, -1.36680603461607, 0.416481080493563, -1.24576265509092, -0.99525146809086, -0.416628541379898, -1.81085239999528, -0.912032027269165, 1.28235725182735, -0.253939926931411, -0.217005654691374, 0.122930911573912, -0.160938479383024, -1.11774096821969, -2.26360893715083, -0.266646354291187, -0.999629139971622, 0.381982880228735, 1.47247686009596, -1.49976060237769, -0.60917993877167, -0.479469560635756, -2.17549620384543, -2.17661171791651, -0.151866599700133, -0.0782864588867642, -0.677067733749534, 0.395064156793028, -0.114147309248195, -1.97991736752715, -2.68147328955025, -0.561483015084098, -0.776767843497335, -1.18151148654383, -0.130242383284544, -0.661851906190109, -1.93557384517515, -0.27967464208681, 0.817754493264576, -2.38279806950875, -1.35556214122599, -0.636895283356902, 0.0250913779567216, -0.0269393599447854, -1.08729488902444, -1.19863675862936, -0.404375383477476, -0.630118840723416, -1.96612749454556, -1.40170898481414, -0.0135002313569274, -1.85299306993256, -1.02081879666053, 0.065108985415705, -0.591001889075999, 0.207411334959125, -0.533552653171463, -1.04078771845184, -0.95055649202109, -1.09508265320838, -1.5645604789542, -1.67671276705074, 1.19424743629687, 1.38525280760506, 0.262117253765008, -0.197994088607004, -0.27833265401043, 0.0391976522639086, -1.32602204960103, -1.16051810302057, -1.18764754064855, 0.538958788149314, -1.095327133933, -0.798225199392442, -0.49891456417664, 1.33522855270653, -0.853747495359658, 0.433951485530481, -1.74127703322739, 0.204140476140153, -1.73898492352553, -0.786164219044212, -2.15874929389241, -2.00188660895579, -1.08943699068763, -0.345891605535527, -1.17322146563172, -1.21414815009287, -1.90033621751792
        );
        String pop = "sp1 sp2 sp3 sp4 sp5 sp6 sp7 sp8 sp9 sp10";
        population.initByName("value", popTraitData, "keys", pop, "minordimension", nTraits);

        // sigma matrix input
        sigmasq = new RealParameter(new Double[]{46.223049296125, 125.192990718271, 78.1029531665942, 35.1078305498511, 25.9560354966226, 31.377907876091, 36.8599535205372, 29.7239297140289, 29.2197920934045, 21.7186073187224, 25.3045273503755, 10.5534230480543, 5.95325560402173, 15.923130508163, 19.7457563776906, 11.882028857891, 13.1366813143093, 6.50298841629207, 12.6328805370952, 10.091003883862});
        delta = new RealParameter(new Double[] {0.891546750451994});
        sigmaMatrix.initByName("sigmasq", sigmasq, "trait", morphData, "shrinkage", true, "delta", delta, "population", population);

        //
        sigmaMatrix.populateRhoMatrix();
        double[] shrinkageRho = sigmaMatrix.getRhoMatrix();

        Assert.assertEquals(-0.0273321055525434, shrinkageRho[24], EPSILON);
        Assert.assertEquals(-0.067546212881596, shrinkageRho[66], EPSILON);
        Assert.assertEquals(0.000400744517263309, shrinkageRho[111], EPSILON);
        Assert.assertEquals(1.0, shrinkageRho[210], EPSILON);
        Assert.assertEquals(0.0545213823328104, shrinkageRho[295], EPSILON);
        Assert.assertEquals(-0.00868680482701823, shrinkageRho[377], EPSILON);
        Assert.assertEquals(0.0103548033747211, shrinkageRho[398], EPSILON);
    }
}
